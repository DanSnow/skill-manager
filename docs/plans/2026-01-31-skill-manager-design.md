# skill-manager Design Document

A Cargo-like plugin manager for Claude Code.

## Problem

Claude Code's plugin system lacks reproducibility. The internal files (`installed_plugins.json`, `known_marketplaces.json`, `settings.json`) are bookkeeping, not shareable manifests. You can't give a teammate a file and say "run this to get my exact setup."

## Solution

A standalone Rust CLI that introduces:
- `plugins.toml` - Human-editable manifest declaring desired plugins
- `plugins.lock` - Auto-generated lock file pinning exact git commits
- Commands to install/sync plugins reproducibly

## Design Principles

1. **Compatible with Claude Code** - Writes to Claude Code's JSON files, pointing to our managed plugin paths. Claude Code remains the source of truth for loading plugins.
2. **Reproducible** - Lock file captures exact state. Same manifest + lock = same plugins everywhere.
3. **Non-destructive** - Doesn't touch Claude Code's marketplace/cache folders. Can coexist with `/plugin install`.
4. **Transparent about external sources** - Clearly shows when plugins come from external repos vs marketplace-local.

## MVP Scope

- Global and project-local manifests
- Install from lock (reproducible) or resolve fresh
- Support GitHub shorthand and git URLs for marketplaces
- Warn on conflicts between global/project plugins

---

## File Formats

### `plugins.toml` (user-edited manifest)

```toml
# ~/.config/skill-manager/plugins.toml (global)
# or ./.claude/plugins.toml (project)

[marketplaces]
official = "anthropics/claude-plugins-official"      # GitHub shorthand
superpowers = "obra/superpowers-marketplace"
sourceatlas = "lis186/SourceAtlas"
private = "git@github.com:mycompany/plugins.git"     # SSH URL
custom = "https://git.example.com/plugins.git"       # Full HTTPS URL

# Marketplace with pinned tag or commit
pinned = { url = "anthropics/claude-plugins-official", tag = "v1.0" }
exact = { url = "anthropics/claude-plugins-official", commit = "abc123" }

[plugins]
# Latest from marketplace (HEAD of default branch)
typescript-lsp = { marketplace = "official" }

# Pin by tag
superpowers = { marketplace = "superpowers", tag = "v4.1.1" }

# Pin by commit (most explicit)
sourceatlas = { marketplace = "sourceatlas", commit = "def456" }
```

### `plugins.lock` (auto-generated)

```toml
# DO NOT EDIT - Generated by skill-manager
# Delete this file to re-resolve versions

lock_version = 1

[[marketplace]]
name = "official"
url = "https://github.com/anthropics/claude-plugins-official.git"
commit = "96276205880a60fd66bbae981f5ab568e70c4cbf"

[[marketplace]]
name = "superpowers"
url = "https://github.com/obra/superpowers-marketplace.git"
commit = "abc123def456..."

[[package]]
name = "typescript-lsp"
marketplace = "official"
source_type = "local"
path = "./plugins/typescript-lsp"
marketplace_commit = "96276205880a60fd66bbae981f5ab568e70c4cbf"
resolved_version = "1.0.0"  # From plugin.json, display only

[[package]]
name = "superpowers"
marketplace = "superpowers"
requested_tag = "v4.1.1"
source_type = "external"
plugin_url = "https://github.com/obra/superpowers.git"
marketplace_commit = "abc123..."
plugin_commit = "def789..."
resolved_version = "4.1.1"
```

### Version Resolution

Marketplaces and plugins do not use semantic version resolution. Pinning is via:
- `tag` - Git tag, resolved to commit
- `commit` - Exact commit hash
- Neither - Latest (HEAD of default branch)

The `resolved_version` in the lock file is read from plugin.json for display purposes only - it is not used for resolution.

---

## CLI Commands

```bash
skill-manager init [--global]
```
- Creates `plugins.toml` in `./.claude/` (project) or `~/.config/skill-manager/` (global)
- If global, prompts to add known marketplaces

```bash
skill-manager add <plugin> [--marketplace <name>] [--tag <tag>] [--commit <sha>]
```
- Adds plugin entry to `plugins.toml`
- If marketplace not specified: searches known marketplaces, prompts user to choose
- If marketplace not in manifest: prompts to add it

```bash
skill-manager install [--update]
```
- Without `--update`: Uses `plugins.lock` if present (reproducible install)
- With `--update` or no lock file: Resolves versions, creates/updates lock
- Clones marketplaces to cache
- Extracts plugins to cache
- Updates Claude Code's `installed_plugins.json` and `settings.json`
- Warns if project plugin conflicts with global plugin

```bash
skill-manager remove <plugin>
```
- Removes from `plugins.toml`
- Does NOT uninstall from Claude Code (manual or future `sync` command)

```bash
skill-manager list
```
- Shows installed plugins, their versions, lock status
- Indicates if running version differs from locked version

---

## Directory Structure

### Our managed storage (XDG spec)

```
~/.config/skill-manager/
├── plugins.toml              # Global manifest
└── plugins.lock              # Global lock file

~/.cache/skill-manager/
├── CACHEDIR.TAG              # Signals backup tools to skip
├── marketplaces/             # Cloned marketplace repos (regenerable)
│   ├── official/
│   └── superpowers/
└── plugins/                  # Extracted plugin files (regenerable)
    ├── official/
    │   └── typescript-lsp/abc123/
    └── superpowers/
        └── superpowers/def456/
```

**CACHEDIR.TAG contents:**
```
Signature: 8a477f597d28d172789f06886806bc55
# This file is a cache directory tag created by skill-manager.
# For information about cache directory tags, see:
#	https://bford.info/cachedir/
```

### Project-local

```
<project>/
└── .claude/
    ├── plugins.toml          # Project manifest
    └── plugins.lock          # Project lock file
```

---

## Integration with Claude Code

### What we write

**`~/.claude/plugins/installed_plugins.json`** - Add entries pointing to our cache:
```json
{
  "superpowers@superpowers-marketplace": [
    {
      "scope": "user",
      "installPath": "/home/user/.cache/skill-manager/plugins/superpowers/superpowers/def456",
      "version": "4.1.1",
      "installedAt": "2026-01-31T12:00:00.000Z",
      "lastUpdated": "2026-01-31T12:00:00.000Z",
      "gitCommitSha": "def456..."
    }
  ]
}
```

**`~/.claude/settings.json`** - Enable plugins in `enabledPlugins`:
```json
{
  "enabledPlugins": {
    "superpowers@superpowers-marketplace": true
  }
}
```

### What we don't touch

- `~/.claude/plugins/marketplaces/` - Claude Code's marketplace clones
- `~/.claude/plugins/cache/` - Claude Code's plugin cache
- `~/.claude/plugins/known_marketplaces.json` - Claude Code's marketplace registry

### Conflict handling

When a plugin exists both globally and in project:
```
$ skill-manager install
Installing superpowers...
  Conflict: superpowers already installed globally at v4.0.0
  Project wants: v4.1.1 (tag: v4.1.1)
  Claude Code loads global over project plugins.
  Options:
    1. Update global install to v4.1.1
    2. Skip (keep global v4.0.0)
    3. Abort
```

---

## Crate Structure

```
skill-manager/
├── Cargo.toml
└── src/
    ├── main.rs              # CLI entry, clap commands
    ├── lib.rs               # Public API
    ├── config/
    │   ├── mod.rs
    │   ├── manifest.rs      # Parse/write plugins.toml
    │   └── lock.rs          # Parse/write plugins.lock
    ├── resolver/
    │   ├── mod.rs
    │   ├── marketplace.rs   # Clone/fetch marketplaces, parse marketplace.json
    │   └── plugin.rs        # Resolve plugin source (local vs external)
    ├── installer/
    │   ├── mod.rs
    │   ├── cache.rs         # Manage ~/.cache/skill-manager/
    │   └── claude.rs        # Write to Claude Code's JSON files
    └── cli/
        ├── mod.rs
        ├── init.rs
        ├── add.rs
        ├── install.rs
        ├── remove.rs
        └── list.rs
```

## Dependencies

Install via `cargo add` (no pinned versions):

- `clap` (features: derive) - CLI parsing
- `toml` - TOML parsing
- `toml_edit` - TOML editing (preserves formatting)
- `serde` (features: derive) - Serialization
- `serde_json` - JSON for Claude Code files
- `git2` - Git operations
- `xdg` - XDG directory resolution
- `thiserror` - Error type derivation
- `rootcause` - Error chain traversal

## Error Handling

```rust
#[derive(Debug, thiserror::Error)]
pub enum Error {
    #[error("marketplace '{0}' not found in manifest")]
    MarketplaceNotFound(String),

    #[error("plugin '{0}' not found in marketplace '{1}'")]
    PluginNotFound(String, String),

    #[error("failed to clone marketplace '{name}'")]
    GitClone {
        name: String,
        #[source]
        source: git2::Error,
    },

    #[error("failed to parse manifest")]
    ManifestParse(#[source] toml::de::Error),

    #[error("failed to read Claude Code settings")]
    ClaudeSettings(#[source] std::io::Error),

    #[error("conflict: plugin '{plugin}' installed globally at {global_version}, project wants {project_version}")]
    PluginConflict {
        plugin: String,
        global_version: String,
        project_version: String,
    },
}
```

---

## Future Improvements (Not MVP)

- `skill-manager export` - Generate manifest from current Claude Code state
- `skill-manager sync` - Remove plugins not in manifest
- `skill-manager search <query>` - Search across marketplaces
- Content-addressable storage for deduplication
- Built-in marketplace browser
- Claude Code plugin with `/sm:*` commands
